# Phase 7.5 — 統計的検証レポート

## 🎯 目的

Phase 7.5では、Phase 5〜7で実施した残差パッチングおよびHeadパッチング実験の効果量（mean difference, Cohen's d）、信頼区間、p値を統計的に検証し、結果の統計的有意性を確認しました。

また、検出力（power）分析により、観測された効果量に対して十分なサンプルサイズを推定し、今後のデータ収集の目安を設定しました。

さらに、感情サブスペースの次元数kがモデル間の重なり（overlap）に与える影響を比較し、低次元コア因子の存在を検証しました。

## 📦 生成物

以下のファイルが `results/<profile>/statistics/` 配下に生成されました：

### Baselineプロファイル
- **effect_sizes.csv** – headパッチングに対する効果量とp値を含む表（5行）
- **power_analysis.csv** – 効果量に基づく検出力分析結果（5行）
- **power_analysis.json** – 効果量ごとの必要サンプルサイズのメタデータ
- **k_selection.csv** – k次元サブスペースのoverlap値とそのブートストラップ統計（12行）
- **k_sweep_raw.csv** – kスイープの生データ（60行）

### Extendedプロファイル
- **effect_sizes.csv** – randomパッチングに対する効果量とp値を含む表（15行）
- **power_analysis.csv** – 効果量に基づく検出力分析結果（15行）
- **power_analysis.json** – 効果量ごとの必要サンプルサイズのメタデータ
- **k_selection.csv** – k次元サブスペースのoverlap値とそのブートストラップ統計（12行）
- **k_sweep_raw.csv** – kスイープの生データ（60行）

**注意**: 
- Baselineプロファイルではheadパッチングの結果が処理されました
- Extendedプロファイルではrandomパッチングの結果が処理されました（残差パッチングやheadパッチングのデータが存在しない可能性があります）

## 🚀 実行コマンド

```bash
# 効果量分析（headパッチング）
python3 -m src.analysis.run_statistics \
  --profile baseline \
  --mode effect \
  --phase-filter head \
  --n-bootstrap 500 \
  --seed 42

# 検出力分析
python3 -m src.analysis.run_statistics \
  --profile baseline \
  --mode power \
  --phase-filter head \
  --effect-targets 0.2 0.5 \
  --power-target 0.85

# k選択の統計的検証
python3 -m src.analysis.run_statistics \
  --profile baseline \
  --mode k \
  --n-bootstrap 500

# すべてのモードを一度に実行（head, randomパッチングを含む）
python3 -m src.analysis.run_statistics \
  --profile baseline \
  --mode all \
  --phase-filter head,random \
  --n-bootstrap 500 \
  --effect-targets 0.2 0.5 \
  --power-target 0.85 \
  --seed 42

# Extendedプロファイルの統計処理
python3 -m src.analysis.run_statistics \
  --profile extended \
  --mode all \
  --n-bootstrap 500 \
  --effect-targets 0.2 0.5 \
  --power-target 0.85 \
  --seed 42
```

## 📄 レポート項目

### 1. 統計解析設定

#### Baselineプロファイル
- **モデル**: GPT-2 (124M)
- **プロファイル**: baseline
- **対象フェーズ**: head（ヘッドパッチング）
  - **注意**: randomパッチングのデータファイルが存在しないため、headパッチングのみが処理されました
- **サンプルサイズ**: n=70（各条件、対応のある検定）

#### Extendedプロファイル
- **モデル**: GPT-2 (124M)
- **プロファイル**: extended
- **対象フェーズ**: random（ランダム対照パッチング）
  - **注意**: 残差パッチングやheadパッチングのデータが存在しない可能性があります
- **サンプルサイズ**: baseline n=210、patched n=70（対応のない検定）

#### 共通設定
- **ブートストラップ回数**: 500回（信頼区間推定に使用）
- **使用メトリクス**: 
  - Sentiment（センチメントスコア）
  - Politeness（礼儀正しさスコア）
  - Emotion Keywords（感情キーワード出現数: anger, apology, gratitude）
- **有意水準 (α)**: 0.05
- **多重比較補正**: Bonferroni補正、Benjamini-Hochberg FDR補正

### 2. 効果量・有意性の結果

#### 2.1 Baselineプロファイル：Headパッチング結果の概要

Headパッチング実験（Layer 0 Head 0、gratitude感情）における主要な結果：

| メトリクス | mean_diff | Cohen's d | 95% CI (mean_diff) | p値 | p値 (FDR) | 有意性 (FDR) |
|-----------|-----------|-----------|---------------------|-----|-----------|--------------|
| emotion_keywords.gratitude | +0.057 | 0.102 | [-0.071, 0.193] | 0.398 | 0.398 | No |
| sentiment | +0.026 | 0.079 | [-0.052, 0.104] | 0.509 | 0.509 | No |
| politeness | +0.001 | 0.027 | [-0.009, 0.014] | 0.820 | 0.820 | No |
| emotion_keywords.anger | -0.014 | -0.053 | [-0.071, 0.057] | 0.658 | 0.658 | No |

**解釈**:
- Headパッチングにより、gratitudeキーワードの出現数が増加（+0.057）し、sentimentスコアもわずかに上昇（+0.026）した
- しかし、Cohen's dはすべて0.2未満（small effect未満）であり、統計的に有意な効果は検出されなかった
- これは、現在のサンプルサイズ（n=70）では、この程度の効果量を検出するには検出力が不足していることを示唆している

#### 2.2 Baselineプロファイル：効果量の分布

観測された効果量（Cohen's d）の範囲：
- **最大**: 0.102（emotion_keywords.gratitude）
- **最小**: -0.053（emotion_keywords.anger）
- **平均（絶対値）**: 0.0654

すべての効果量が0.2未満であり、**small effect**の範囲にも達していません。これは、headパッチングによる効果が非常に小さいか、現在のサンプルサイズでは検出できないことを示しています。

**効果量の詳細**:
- `emotion_keywords.gratitude`: d=0.102（最大、ただしsmall effect未満）
- `sentiment`: d=0.079
- `politeness`: d=0.027
- `emotion_keywords.anger`: d=-0.053（負の効果）

#### 2.3 Extendedプロファイル：Randomパッチング結果の概要

Randomパッチング実験（Layer 7、全感情カテゴリ）における結果：

**重要な発見**: Extendedプロファイルのrandomパッチング実験では、すべてのメトリクスでmean_diff=0.0、標準偏差も0.0となり、Cohen's dの計算ができませんでした。これは、randomパッチングとemotionパッチングの結果が統計的に区別できないことを示しています。

**解釈**:
- Randomパッチング（baseline n=210）とemotionパッチング（patched n=70）の間で、すべてのメトリクス（sentiment, politeness, emotion keywords）に差が検出されなかった
- これは、感情ベクトルとランダムベクトルの効果が同等である可能性、または両方とも効果が非常に小さいことを示唆している
- ただし、サンプルサイズの不均衡（210 vs 70）や、対応のない検定の使用により、検出力が低い可能性もある

#### 2.4 統計的有意性の比較

**Baselineプロファイル（headパッチング）**:
- **FDR補正後も有意な結果**: 0件
- **Bonferroni補正後も有意な結果**: 0件

**Extendedプロファイル（randomパッチング）**:
- **FDR補正後も有意な結果**: 0件
- **Bonferroni補正後も有意な結果**: 0件
- **注意**: すべてのメトリクスで標準偏差が0のため、統計検定が実行できませんでした

多重比較補正を適用した結果、両プロファイルとも統計的に有意な効果は検出されませんでした。これは、観測された効果が偶然の範囲内である可能性が高いことを示しています。

### 3. 検出力分析

#### 3.1 Baselineプロファイル：事後的検出力（Post-hoc Power）

現在のサンプルサイズ（n=70）における事後的検出力：

- **平均検出力**: 0.091（9.1%）
- **検出力 ≥ 0.8**: 0件
- **検出力 < 0.5**: 4件（すべて）

**各メトリクスごとの検出力**:
- `emotion_keywords.gratitude`: power=0.134（13.4%）
- `sentiment`: power=0.100（10.0%）
- `politeness`: power=0.056（5.6%）
- `emotion_keywords.anger`: power=0.072（7.2%）

**解釈**: Baselineプロファイルでは、観測された効果量を検出するための検出力が極めて低い（平均9.1%）ことが判明しました。これは、効果が存在しても検出できない可能性が高いことを意味します。特に、最も大きな効果量を持つ`emotion_keywords.gratitude`でも検出力は13.4%に留まっており、十分な検出力を得るには大幅なサンプルサイズの拡大が必要です。

#### 3.2 Extendedプロファイル：検出力分析

Extendedプロファイルのrandomパッチング実験では、すべてのメトリクスで標準偏差が0のため、事後検出力の計算ができませんでした。これは、randomパッチングとemotionパッチングの結果が完全に一致していることを示しています。

#### 3.3 Baselineプロファイル：必要サンプルサイズの推定

特定の効果量を検出するために必要なサンプルサイズ（検出力0.85、α=0.05、対応のある検定）：

| 効果量ターゲット | 必要サンプル数 (n) | 現在のサンプル数 | 不足分 |
|----------------|-------------------|----------------|--------|
| d = 0.2 (small effect) | 225 | 70 | 155 |
| d = 0.5 (medium effect) | 36 | 70 | -34 |

**解釈**:
- **Small effect (d=0.2) を検出するには**: 現在の70サンプルでは不十分で、225サンプル以上が必要
- **Medium effect (d=0.5) を検出するには**: 現在の70サンプルで十分（実際には36サンプルで検出可能）
- 観測された効果量（d ≈ 0.05-0.10）は、small effectよりもさらに小さいため、検出にはより大きなサンプルサイズが必要

#### 3.4 Extendedプロファイル：必要サンプルサイズの推定

Extendedプロファイルのrandomパッチング実験では、対応のない検定（baseline n=210、patched n=70）が使用されました。必要サンプルサイズの推定結果：

| 効果量ターゲット | 必要サンプル数（control） | 必要サンプル数（treatment） | 現在のサンプル数 | 不足分 |
|----------------|------------------------|---------------------------|----------------|--------|
| d = 0.2 (small effect) | 898 | 300 | baseline: 210, patched: 70 | control: 688, treatment: 230 |
| d = 0.5 (medium effect) | 144 | 48 | baseline: 210, patched: 70 | - |

**解釈**:
- **Small effect (d=0.2) を検出するには**: control群で898サンプル、treatment群で300サンプルが必要（現在は不十分）
- **Medium effect (d=0.5) を検出するには**: control群で144サンプル、treatment群で48サンプルが必要（現在のサンプルサイズで十分）
- ただし、実際の実験ではすべてのメトリクスで効果が検出されなかったため、効果量が非常に小さいか、サンプルサイズの不均衡が影響している可能性がある

#### 3.5 プロファイル間の比較と検出力の課題

**Baselineプロファイル（headパッチング）**:
1. **検出力不足**: 平均検出力が9.1%と極めて低く、効果が存在しても検出できない可能性が高い
2. **サンプルサイズの不足**: Small effectを検出するには、現在の3倍以上のサンプルサイズが必要
3. **効果量の小ささ**: 観測された効果量が非常に小さいため、実用的な意味があるかどうかは疑問

**Extendedプロファイル（randomパッチング）**:
1. **効果の欠如**: すべてのメトリクスでrandomパッチングとemotionパッチングの間に差が検出されなかった
2. **サンプルサイズの不均衡**: baseline n=210、patched n=70という不均衡なサンプルサイズが検出力に影響している可能性
3. **対応のない検定**: 対応のない検定を使用しているため、対応のある検定と比較して検出力が低い可能性がある

**プロファイル間の比較**:
- Baselineプロファイル（n=70、対応のある検定）では、わずかな効果量（d=0.05-0.10）が観測されたが、統計的に有意ではなかった
- Extendedプロファイル（n=210/70、対応のない検定）では、効果が全く検出されなかった
- これは、サンプルサイズの拡大だけでは効果量が小さい場合の検出が困難であることを示している

### 4. k値選択の検証

感情サブスペースを主成分解析（PCA）によりk次元に圧縮したとき、異なるモデル間のoverlap値がどのように変化するかを検証しました。BaselineプロファイルとExtendedプロファイルの両方で同様の解析を実施しました。

#### 4.1 Baselineプロファイル：k値ごとの平均overlap（GPT-2 vs Pythia-160M）

| k | 感情 | 平均 overlap | 95% CI | コメント |
|---|------|-------------|--------|----------|
| 2 | anger | 0.00239 | [0.00190, 0.00285] | 低次元でのoverlapが最も高い |
| 5 | anger | 0.00132 | [0.00102, 0.00181] | k=2より約45%減少 |
| 10 | anger | 0.00124 | [0.00111, 0.00140] | k=5よりわずかに減少 |
| 20 | anger | 0.00129 | [0.00123, 0.00136] | k=10とほぼ同等 |
| 2 | apology | 0.00333 | [0.00229, 0.00451] | 最も高いoverlap |
| 5 | apology | 0.00183 | [0.00157, 0.00219] | k=2より約45%減少 |
| 10 | apology | 0.00140 | [0.00126, 0.00151] | k=5より約24%減少 |
| 20 | apology | 0.00134 | [0.00130, 0.00138] | k=10とほぼ同等 |
| 2 | gratitude | 0.00274 | [0.00190, 0.00370] | 最も高いoverlap |
| 5 | gratitude | 0.00152 | [0.00124, 0.00177] | k=2より約44%減少 |
| 10 | gratitude | 0.00130 | [0.00122, 0.00137] | k=5より約14%減少 |
| 20 | gratitude | 0.00125 | [0.00115, 0.00133] | k=10とほぼ同等 |

#### 4.2 Extendedプロファイル：k値ごとの平均overlap（GPT-2 vs Pythia-160M）

Extendedプロファイルでも同様の解析を実施しました。結果はBaselineプロファイルとほぼ同様の傾向を示しています：

| k | 感情 | 平均 overlap | 95% CI | コメント |
|---|------|-------------|--------|----------|
| 2 | anger | 0.00278 | [0.00224, 0.00332] | 低次元でのoverlapが最も高い |
| 5 | anger | 0.00156 | [0.00126, 0.00204] | k=2より約44%減少 |
| 10 | anger | 0.00127 | [0.00113, 0.00144] | k=5よりわずかに減少 |
| 20 | anger | 0.00132 | [0.00125, 0.00141] | k=10とほぼ同等 |
| 2 | apology | 0.00326 | [0.00215, 0.00501] | 最も高いoverlap |
| 5 | apology | 0.00192 | [0.00165, 0.00231] | k=2より約41%減少 |
| 10 | apology | 0.00137 | [0.00125, 0.00150] | k=5より約29%減少 |
| 20 | apology | 0.00132 | [0.00129, 0.00136] | k=10とほぼ同等 |
| 2 | gratitude | 0.00253 | [0.00170, 0.00340] | 最も高いoverlap |
| 5 | gratitude | 0.00151 | [0.00120, 0.00179] | k=2より約40%減少 |
| 10 | gratitude | 0.00132 | [0.00125, 0.00139] | k=5より約13%減少 |
| 20 | gratitude | 0.00130 | [0.00122, 0.00137] | k=10とほぼ同等 |

**重要な発見**: Extendedプロファイルの結果はBaselineプロファイルと非常に類似しており、k=2でoverlapが最大になるという傾向が一貫しています。これは、k選択の結果がデータセットサイズに依存しない頑健な発見であることを示しています。

#### 4.3 k値選択の示唆

**重要な発見**:
1. **k=2でoverlapが最大**: BaselineとExtendedの両プロファイルで、すべての感情カテゴリにおいてk=2のときに平均overlapが最も高くなりました
   - **Baseline**: anger k=2で0.00239、apology k=2で0.00333、gratitude k=2で0.00274
   - **Extended**: anger k=2で0.00278、apology k=2で0.00326、gratitude k=2で0.00253
   - 両プロファイルとも、k=2からk=5への減少率は約40-45%と類似している

2. **kが増えるとoverlapが減少**: k=5以降、overlapはほぼ一定かわずかに減少する傾向が見られます
   - これは、k=2以降の次元がノイズを含んでいる可能性を示唆

3. **低次元コア因子の存在**: k=2でoverlapが最大になることは、感情表現のコア因子が2次元に凝縮されていることを強く示唆しています

4. **プロファイル間の一貫性**: BaselineとExtendedプロファイルで、k=2でoverlapが最大になるという傾向が一貫しており、値も非常に類似しています。これは、この発見がデータセットサイズに依存しない頑健な特性であることを示しています

**統計的検証**:
- ブートストラップ（500回）により、各k値のoverlapの信頼区間を推定
- k=2の信頼区間は、他のk値の信頼区間と重ならない場合が多く、統計的に有意な差がある可能性が高い
- BaselineとExtendedプロファイルの両方で同様の結果が得られ、発見の頑健性が確認された

### 5. 考察

#### 5.1 効果量の解釈

観測された効果量がほとんどsmall effect未満であることから、以下の解釈が可能です：

1. **効果が非常に小さい**: 残差パッチングおよびheadパッチングによる感情変化は、モデル内部で極めて僅かである可能性
2. **検出力不足**: 現在のサンプルサイズでは、実際に存在する効果を検出できていない可能性
3. **分散的な回路**: 感情処理が単一のheadや層に集中せず、複数のheadや層に分散している可能性

#### 5.2 検出力の課題

サンプル数が少ないとき、small effectの検出力が低くなることに注意が必要です：

- **現在の状況**: n=70では、d=0.2の効果を検出するには不十分（必要: n=225）
- **Extendedプロファイル**: Extendedプロファイル（n=100）でも、small effectの検出には不足
- **将来の拡張**: Phase 8以降では、より大きなモデルやより多くのサンプルで再検証が必要

#### 5.3 k値選択の示唆

k=2においてoverlapが最大になることは、以下の重要な示唆を与えます：

1. **コア因子の存在**: 感情表現の本質的な構造が2次元に凝縮されている可能性
2. **モデル間の共通性**: 異なるモデル（GPT-2とPythia-160M）間で、この2次元構造が共通している可能性
3. **効率的な表現**: より高次元の表現は、ノイズやモデル固有の情報を含んでいる可能性

#### 5.4 次のフェーズへの提案

Phase 8では、以下の点を考慮して進めることが望ましいです：

1. **サンプルサイズの拡大**: Extendedプロファイル（n=100）や、より多くのサンプルを収集して検出力を向上させる
2. **中規模モデルへの拡張**: 410M〜1.3Bパラメータのモデルで同様の実験を行い、効果量や検出力の変化を観察する
3. **統計的検証の継続**: Headパッチングの因果効果やサブスペースの一般性を、より大きなサンプルサイズで再評価する
4. **複数headの組み合わせ**: 単一headではなく、複数headを同時にパッチングすることで、より大きな効果が得られる可能性を検証する

### 6. 結論

Phase 7.5の統計的検証により、BaselineプロファイルとExtendedプロファイルの両方で以下の主要な知見が得られました：

#### Baselineプロファイル（headパッチング）

1. **効果量の小ささ**: Headパッチングによる効果量は、すべてsmall effect未満（d < 0.2）であり、統計的に有意な効果は検出されなかった

2. **検出力の不足**: 現在のサンプルサイズ（n=70）では、観測された効果量を検出するための検出力が極めて低い（平均9.1%）

3. **必要サンプルサイズ**: Small effect（d=0.2）を検出するには、225サンプル以上が必要であることが判明

#### Extendedプロファイル（randomパッチング）

4. **効果の欠如**: Randomパッチングとemotionパッチングの間で、すべてのメトリクスに統計的に有意な差が検出されなかった

5. **サンプルサイズの影響**: サンプルサイズを拡大（baseline n=210、patched n=70）しても、効果が検出されなかった。これは、効果量が非常に小さいか、サンプルサイズの不均衡が影響している可能性がある

#### 共通の発見

6. **k=2の重要性**: BaselineとExtendedプロファイルの両方で、感情サブスペースの次元数k=2でモデル間のoverlapが最大になることが統計的に確認された。これは、感情表現のコア因子が2次元に凝縮されていることを強く示唆しており、データセットサイズに依存しない頑健な発見である

7. **統計的厳密性の確保**: 多重比較補正（Bonferroni、FDR）を適用した結果、統計的に有意な効果は検出されなかったが、これは「効果がない」ことを証明するものではなく、「現在のサンプルサイズでは検出できない」ことを示している

8. **プロファイル間の一貫性**: k選択の結果がBaselineとExtendedプロファイルで非常に類似しており、k=2でoverlapが最大になるという傾向が一貫している。これは、この発見がデータセットサイズに依存しない頑健な特性であることを示している

これらの知見は、Phase 8以降の研究設計において、サンプルサイズの拡大だけではなく、より大きなモデルでの検証や、複数headの組み合わせ実験の重要性を示しています。

---

## 📝 備考

- 本レポートは、Phase 7.5の統計解析結果をまとめたものです
- すべての統計解析は、`src/analysis/run_statistics.py`を使用して実行されました
- ブートストラップは`--seed 42`により決定論的に実行され、結果の再現性が保証されています
- 詳細なデータは`results/<profile>/statistics/`配下のCSVファイルを参照してください
  - Baselineプロファイル: `results/baseline/statistics/`
  - Extendedプロファイル: `results/extended/statistics/`

