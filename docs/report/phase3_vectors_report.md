# Phase 3 â€” Emotion Vector Construction

## ğŸ¯ ç›®çš„

- sentence-end vectorsï¼ˆæ–‡ç« æœ«ã® residualï¼‰
- token-based vectorsï¼ˆemotion token ãƒ™ãƒ¼ã‚¹ï¼‰
- å„æ„Ÿæƒ…ã®å¹³å‡ãƒ™ã‚¯ãƒˆãƒ«ã‚’è¨ˆç®—

## ğŸ“¦ ç”Ÿæˆç‰©

- `results/baseline/emotion_vectors/gpt2_vectors.pkl` (sentence-end) âœ…
- `results/baseline/emotion_vectors/gpt2_vectors_token_based.pkl` (token-based) âœ…
- `results/baseline/cross_model_similarity_token_based.csv` âœ…
- `docs/report/phase3_vectors_report.md` âœ…

## ğŸš€ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ä¾‹

```bash
python -m src.analysis.emotion_vectors --activations_dir results/baseline/activations/gpt2 --output results/baseline/emotion_vectors/gpt2_vectors.pkl
python -m src.analysis.emotion_vectors_token_based --activations_dir results/baseline/activations/gpt2 --output results/baseline/emotion_vectors/gpt2_vectors_token_based.pkl
python -m src.analysis.cross_model_token_based --profile baseline --vectors_dir results/baseline/emotion_vectors --models gpt2 EleutherAI-pythia-160m EleutherAI-gpt-neo-125M --output_table results/baseline/cross_model_similarity_token_based.csv
```

## ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆé …ç›®

### 1. sentence-end / token-based æ‰‹æ³•ã®æ¯”è¼ƒ

#### Sentence-endæ‰‹æ³•
- **èª¬æ˜**: æ–‡ç« æœ«ã®residual streamã‚’ä½¿ç”¨ã—ã¦æ„Ÿæƒ…ãƒ™ã‚¯ãƒˆãƒ«ã‚’è¨ˆç®—
- **ãƒ¡ãƒªãƒƒãƒˆ**: æ–‡å…¨ä½“ã®æ„Ÿæƒ…è¡¨ç¾ã‚’åæ˜ ã§ãã‚‹
- **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**: æ–‡æœ«ä»¥å¤–ã®æ„Ÿæƒ…èªãƒˆãƒ¼ã‚¯ãƒ³ã®å½±éŸ¿ãŒè–„ã‚Œã‚‹å¯èƒ½æ€§

#### Token-basedæ‰‹æ³•
- **èª¬æ˜**: æ„Ÿæƒ…èªãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ"thank", "frustrated", "sorry"ãªã©ï¼‰ã®residual streamã‚’ä½¿ç”¨ã—ã¦æ„Ÿæƒ…ãƒ™ã‚¯ãƒˆãƒ«ã‚’è¨ˆç®—
- **ãƒ¡ãƒªãƒƒãƒˆ**: æ„Ÿæƒ…èªãƒˆãƒ¼ã‚¯ãƒ³ã«ç›´æ¥å¯¾å¿œã™ã‚‹ãŸã‚ã€ã‚ˆã‚Šæ˜ç¢ºãªæ„Ÿæƒ…è¡¨ç¾ã‚’æŠ½å‡ºå¯èƒ½
- **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**: æ„Ÿæƒ…èªãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã®å‡¦ç†ãŒå¿…è¦

#### æ¯”è¼ƒçµæœ

| æ‰‹æ³• | å®‰å®šæ€§ | è§£é‡ˆå¯èƒ½æ€§ | è¨ˆç®—ã‚³ã‚¹ãƒˆ |
|------|--------|----------|-----------|
| Sentence-end | ä¸­ | ä¸­ | ä½ |
| Token-based  | é«˜ | é«˜ | ä½ |

### 2. æ„Ÿæƒ…é–“ã® cosine é¡ä¼¼ï¼ˆè¡¨ï¼‰

#### Sentence-endæ‰‹æ³•ï¼ˆLayer 6ï¼‰

| æ„Ÿæƒ…1 | æ„Ÿæƒ…2 | Cosineé¡ä¼¼åº¦ |
|------|------|------------|
| Gratitude | Anger | 0.3706 |
| Gratitude | Apology | 0.6179 |
| Anger | Apology | 0.7497 |

#### Token-basedæ‰‹æ³•ï¼ˆLayer 6ï¼‰

| æ„Ÿæƒ…1 | æ„Ÿæƒ…2 | Cosineé¡ä¼¼åº¦ |
|------|------|------------|
| Gratitude | Anger | 0.1638 |
| Gratitude | Apology | 0.3605 |
| Anger | Apology | 0.7300 |

**è€ƒå¯Ÿ**: Token-basedæ‰‹æ³•ã®æ–¹ãŒã€Gratitudeã¨Angerã®é¡ä¼¼åº¦ãŒä½ãï¼ˆ0.1638 vs 0.3706ï¼‰ã€ã‚ˆã‚Šæ˜ç¢ºã«æ„Ÿæƒ…ã‚’åŒºåˆ¥ã§ãã¦ã„ã‚‹ã€‚

### 3. å±¤ã”ã¨ã®ãƒ™ã‚¯ãƒˆãƒ«å¼·åº¦

#### L1 Normï¼ˆToken-basedï¼‰

| å±¤ | Gratitude | Anger | Apology |
|----|----------|-------|---------|
| 0  | 41.9986  | 10.8748 | 12.4813 |
| 3  | 559.2527 | 179.3054 | 198.5565 |
| 6  | 737.5916 | 372.0685 | 395.8407 |
| 9  | 1140.3142 | 788.9581 | 812.2507 |
| 11 | 1622.9573 | 1041.7776 | 1224.7178 |

#### L2 Normï¼ˆToken-basedï¼‰

| å±¤ | Gratitude | Anger | Apology |
|----|----------|-------|---------|
| 0  | 2.2142   | 0.5095 | 0.6258 |
| 3  | 25.9177  | 8.4148 | 9.2743 |
| 6  | 34.4601  | 16.8275 | 17.8767 |
| 9  | 52.8324  | 35.4163 | 36.4373 |
| 11 | 77.5312  | 47.8000 | 57.5133 |

**è€ƒå¯Ÿ**: å±¤ãŒæ·±ããªã‚‹ã»ã©ãƒ™ã‚¯ãƒˆãƒ«å¼·åº¦ãŒå¢—åŠ ã—ã€ç‰¹ã«Layer 9-11ã§å¼·ã„æ„Ÿæƒ…è¡¨ç¾ãŒç¾ã‚Œã‚‹ã€‚

### 4. ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã®å½±éŸ¿

#### æ„Ÿæƒ…èªãƒˆãƒ¼ã‚¯ãƒ³æ•°
- å„æ„Ÿæƒ…ã‚«ãƒ†ã‚´ãƒªã§æ„Ÿæƒ…èªãƒˆãƒ¼ã‚¯ãƒ³ãŒ1-3å€‹ç¨‹åº¦å­˜åœ¨
- Token-basedæ‰‹æ³•ã§ã¯ã€æœ€åˆã®æ„Ÿæƒ…èªãƒˆãƒ¼ã‚¯ãƒ³ä½ç½®ã‚’ä½¿ç”¨ï¼ˆposition_strategy="first"ï¼‰

#### ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã¨ãƒ™ã‚¯ãƒˆãƒ«å®‰å®šæ€§
- Token-basedæ‰‹æ³•ã§ã¯ã€æ„Ÿæƒ…èªãƒˆãƒ¼ã‚¯ãƒ³ãŒæ˜ç¢ºã«å­˜åœ¨ã™ã‚‹ãŸã‚ã€ãƒ™ã‚¯ãƒˆãƒ«ãŒå®‰å®šã—ã¦ã„ã‚‹
- Sentence-endæ‰‹æ³•ã§ã¯ã€æ–‡æœ«ä½ç½®ãŒæ„Ÿæƒ…èªãƒˆãƒ¼ã‚¯ãƒ³ã¨ä¸€è‡´ã—ãªã„å ´åˆãŒã‚ã‚‹

### 5. ãƒ¢ãƒ‡ãƒ«é–“æ¯”è¼ƒ

#### ãƒ¢ãƒ‡ãƒ«é–“ã®æ„Ÿæƒ…ãƒ™ã‚¯ãƒˆãƒ«é¡ä¼¼åº¦ï¼ˆToken-basedã€å¹³å‡ï¼‰

| ãƒ¢ãƒ‡ãƒ«1 | ãƒ¢ãƒ‡ãƒ«2 | Gratitude | Anger | Apology |
|---------|---------|----------|-------|---------|
| gpt2    | pythia-160m | -0.0567 | 0.0055 | 0.0199 |
| gpt2    | gpt-neo-125M | -0.0447 | -0.0100 | -0.0049 |
| pythia-160m | gpt-neo-125M | -0.0097 | -0.0025 | 0.0021 |

**è€ƒå¯Ÿ**: ãƒ¢ãƒ‡ãƒ«é–“ã®é¡ä¼¼åº¦ãŒã»ã¼0ã«è¿‘ãã€ãƒ¢ãƒ‡ãƒ«é–“ã§æ„Ÿæƒ…ãƒ™ã‚¯ãƒˆãƒ«ã®åº§æ¨™ç³»ãŒå¤§ããç•°ãªã‚‹ã“ã¨ãŒç¤ºå”†ã•ã‚Œã‚‹ã€‚

### 6. è€ƒå¯Ÿ

#### æ‰‹æ³•ã®é¸æŠ
- **Token-basedæ‰‹æ³•ã‚’æ¡ç”¨**: ã‚ˆã‚Šæ˜ç¢ºãªæ„Ÿæƒ…è¡¨ç¾ã‚’æŠ½å‡ºã§ãã€Gratitudeã¨Angerã®åŒºåˆ¥ãŒæ˜ç¢º
- Phase 4ä»¥é™ã®Activation Patchingå®Ÿé¨“ã§ã¯ã€Token-basedãƒ™ã‚¯ãƒˆãƒ«ã‚’ä½¿ç”¨

#### ç™ºè¦‹
- Token-basedæ‰‹æ³•ã«ã‚ˆã‚Šã€Pythia-160Mã®ã€Œå…¨éƒ¨0.99ã€ç¾è±¡ãŒå¤§å¹…ã«è§£æ¶ˆ
- å±¤ãŒæ·±ããªã‚‹ã»ã©æ„Ÿæƒ…ãƒ™ã‚¯ãƒˆãƒ«ã®å¼·åº¦ãŒå¢—åŠ 
- ãƒ¢ãƒ‡ãƒ«é–“ã®é¡ä¼¼åº¦ãŒä½ã„ï¼ˆ-0.1ã€œ0.02ã®ç¯„å›²ï¼‰

#### èª²é¡Œ
- ãƒ¢ãƒ‡ãƒ«é–“ã®é¡ä¼¼åº¦ãŒä½ãã€ã‚¯ãƒ­ã‚¹ãƒ¢ãƒ‡ãƒ«ã§ã®æ„Ÿæƒ…ãƒ™ã‚¯ãƒˆãƒ«è»¢é€ãŒå›°é›£
- Phase 6ã®ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹æ³•ãŒå¿…è¦

#### æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®æº–å‚™
- Phase 4ä»¥é™ã§ã¯ã€Token-basedãƒ™ã‚¯ãƒˆãƒ«ã‚’ä½¿ç”¨ã—ã¦Activation Patchingå®Ÿé¨“ã‚’å®Ÿæ–½
- Phase 6ã§ã¯ã€ãƒ¢ãƒ‡ãƒ«é–“ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹æ³•ã‚’æ¤œè¨¼

## ğŸ“ å‚™è€ƒ

- ãƒ™ã‚¯ãƒˆãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯`results/baseline/emotion_vectors/`ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹
- Token-basedãƒ™ã‚¯ãƒˆãƒ«ãŒæ¨å¥¨ã•ã‚Œã‚‹ï¼ˆã‚ˆã‚Šæ˜ç¢ºãªæ„Ÿæƒ…è¡¨ç¾ã‚’æŠ½å‡ºå¯èƒ½ï¼‰
- ãƒ¢ãƒ‡ãƒ«é–“æ¯”è¼ƒçµæœã¯`results/baseline/cross_model_similarity_token_based.csv`ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹

